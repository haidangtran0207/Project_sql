{
"WITH customer_ltv AS (\r\nSELECT\r\n\tcustomerkey,\r\n\tcleaned_name,\r\n\tSUM(total_net_revenue) AS total_ltv\t\r\nFROM\r\n\tcohort_analysis c \r\nGROUP BY\r\n\tc.customerkey,\r\n\tc.cleaned_name\r\n), customer_segment AS(\r\n\t\r\nSELECT \t\r\n\tPERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY total_ltv) AS ltv_25th_percentile,\r\n\tPERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY total_ltv) AS ltv_75th_percentile\r\n\r\nFROM customer_ltv\r\n), segment_values AS (\r\nSELECT \r\n\tc.*,\r\n\tCASE\r\n\t\tWHEN c.total_ltv  < cs.ltv_25th_percentile  THEN '1- Low-Value'\r\n\t\tWHEN c.total_ltv  > cs.ltv_75th_percentile  THEN '3- High-Value'\r\n\t\tELSE '2-Mid-Value'\r\n\tEND AS customer_segment\r\n\t\r\nFROM\r\n\tcustomer_ltv  c,\r\n\tcustomer_segment cs\t\r\n\r\n) \r\nSELECT \r\n\tcustomer_segment,\r\n\tSUM(total_ltv) AS total_ltv ,\r\n\tCOUNT(customerkey) AS customer_count,\r\n\tSUM(total_ltv)\/COUNT(customerkey) AS avg_ltv\r\nFROM \r\n\tsegment_values \r\nGROUP BY customer_segment \r\nORDER BY total_ltv DESC": [
	{
		"customer_segment" : "3- High-Value",
		"total_ltv" : 1.3542927726549798E8,
		"customer_count" : 12372,
		"avg_ltv" : 10946.433661938085
	},
	{
		"customer_segment" : "2-Mid-Value",
		"total_ltv" : 6.6636451787238784E7,
		"customer_count" : 24743,
		"avg_ltv" : 2693.1435875697684
	},
	{
		"customer_segment" : "1- Low-Value",
		"total_ltv" : 4341809.527328112,
		"customer_count" : 12372,
		"avg_ltv" : 350.93837110637827
	}
]}
